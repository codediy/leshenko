!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var i;n.r(e),function(t){t[t.Home=0]="Home",t[t.NextCommit=1]="NextCommit",t[t.PrevCommit=2]="PrevCommit",t[t.SeekCommit=3]="SeekCommit",t[t.ChangeHash=4]="ChangeHash",t[t.OpenFile=5]="OpenFile",t[t.CloseFile=6]="CloseFile",t[t.LoadComments=7]="LoadComments",t[t.PostComment=8]="PostComment"}(i||(i={}));const o=document.getElementById("loading"),s=document.querySelector("section.message"),a=s.querySelector(".title"),m=s.querySelector(".message"),r=s.querySelector(".comments"),l=r.querySelector(".count"),c=r.querySelector(".content"),d=r.querySelector("form"),h=d.elements.namedItem("comment"),u=d.elements.namedItem("name"),f=d.elements.namedItem("email"),p=d.querySelector("button"),C=d.querySelector(".ok"),y=document.querySelector("section.diff"),g=document.querySelector(".diff-content"),v=document.querySelector(".clone-details"),b=document.getElementById("clone-cmd"),w=document.getElementById("checkout-cmd"),x=document.querySelector("section.file"),I=document.querySelector(".file .name"),E=document.querySelector(".file-content"),L=document.querySelector(".file-close"),S=document.getElementById("home-btn"),k=document.getElementById("prev-btn"),j=document.getElementById("next-btn"),P=document.getElementById("progress-bar"),q=P.querySelector(".fill"),F=P.querySelector(".dots");function O(t){const e=t.target.dataset.copyFrom;if(!e)return;const n=document.getElementById(e);n&&n.textContent&&(navigator.clipboard.writeText(n.textContent),n.classList.add("cmd-flash"),setTimeout(()=>{n.classList.remove("cmd-flash")},400))}function $([t,{hunks:e}]){return`<details open data-diff-file="${t}"><summary>${t}</summary> ${e.map(t=>`<p class="hunk">${t.title}</p> ${t.diff}`).join("")}</details>`}function B(t){l.textContent=null==t?"":`(${t})`}function T(){var t;(null!==(t=c.querySelector(".comment"))&&void 0!==t?t:r).scrollIntoView({block:"nearest",behavior:"smooth"})}document.querySelectorAll(".copy").forEach(t=>{t.addEventListener("click",O)});const H=new class{constructor(t){this.dataPath=t,this.commits=[],this.objects={},this._totalCommits=0,this.chunks=[],this.commitIdToIndex={}}async loadIndex(){const t=await fetch(this.dataPath+"index.json"),e=await t.json();this._totalCommits=e.total_commits,this.chunks=Object.entries(e.chunks).map(([t,e])=>[parseInt(t),e]).sort(),this.commitIdToIndex=e.commit_id_to_index}get totalCommits(){return this._totalCommits}async getCommitByIndex(t){return t>=this.commits.length&&await this.preloadUntilIndex(t),this.preloadUntilIndex(t+3),this.commits[t]}getObject(t){return this.objects[t]}getCommitIndexFromId(t){var e;return null!==(e=this.commitIdToIndex[t])&&void 0!==e?e:0}async preloadUntilIndex(t){this.currentPreload&&await this.currentPreload;const e=this.commits,n=this.chunks.filter(([n])=>e.length-1<n&&n<=t).map(([,t])=>t);this.currentPreload=Promise.all(n.map(t=>fetch(this.dataPath+t).then(t=>t.json())));const i=await this.currentPreload;this.currentPreload=void 0,e.push(...i.map(t=>t.commits).flat());for(const{objects:t}of i)Object.assign(this.objects,t)}}("commits/"),_=new class{constructor(t){this.endpoint=t}async getCommentCount(t){let{count:e}=await fetch(`${this.endpoint}/count/${t}.json`,{credentials:"include"}).then(t=>t.json());return e}async getComments(t){return await fetch(`${this.endpoint}/${t}.json`,{credentials:"include"}).then(t=>t.json())}async postComment(t,e,n,i){let o={author:e,email:n,body:i};try{return!!(await fetch(`${this.endpoint}/${t}.json`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(t=>t.json())).success}catch{return!1}}}("//ugit-api.leshenko.net/comments"),N=new class{constructor(){this.sendEvent=()=>{},this.requestedLoadComments=!0,S.addEventListener("click",()=>this.sendEvent({type:i.Home})),k.addEventListener("click",()=>this.sendEvent({type:i.PrevCommit})),j.addEventListener("click",()=>this.sendEvent({type:i.NextCommit})),L.addEventListener("click",()=>this.sendEvent({type:i.CloseFile})),document.addEventListener("keydown",t=>{if(!t.target||!["input","textarea"].includes(t.target.tagName.toLowerCase()))switch(t.key){case"ArrowLeft":this.sendEvent({type:i.PrevCommit});break;case"ArrowRight":this.sendEvent({type:i.NextCommit})}}),window.addEventListener("hashchange",()=>{this.sendEvent({type:i.ChangeHash,commitId:window.location.hash.substr(1)})}),g.addEventListener("click",t=>{let e=t.target;for(;e&&e!=g&&!e.dataset.line;)e=e.parentElement;if(!e||e==g)return;if(!e.dataset.line)return;const n=parseInt(e.dataset.line);for(;e&&e!=g&&!e.dataset.diffFile;)e=e.parentElement;if(!e||!e.dataset.diffFile)throw"diff-file not found";const o=e.dataset.diffFile;this.sendEvent({type:i.OpenFile,file:o,line:n})}),P.addEventListener("click",t=>{if(null==this.totalCommits)return;const e=F.getBoundingClientRect(),n=(t.clientX-e.x)/e.width,o=Math.round(n*(this.totalCommits-1));this.sendEvent({type:i.SeekCommit,commit:o})}),r.addEventListener("toggle",()=>{r.open&&T(),r.open&&!this.requestedLoadComments&&(this.requestedLoadComments=!0,this.sendEvent({type:i.LoadComments}))}),d.addEventListener("submit",t=>{t.preventDefault(),p.disabled=!0,C.style.display="none",this.sendEvent({type:i.PostComment,body:h.value,name:u.value,email:f.value})})}reportError(t){alert(t)}loadCommit(t,e,n){this.setLoading(!1),this.closeFile(),function(t){a.textContent=t.title,m.innerHTML=t.message}(t),B(),c.textContent="Loading...",d.style.display="none",function(t){const e=Object.entries(t.diff).sort().map($).join("");g.innerHTML=e+function(t){const e=Object.keys(t.tree).sort().map(e=>[e,e in t.diff]);return`<details><summary>All Files (${e.length})</summary><ul class="file-list">`+e.map(([t,e])=>`<li data-diff-file="${t}" data-line="1" ${e?'class="changed"':""}>${t}</li>`).join("")+"</ul></details>"}(t)}(t),function(t){b.textContent=`git clone ${location.origin+location.pathname}repo/ ugit`,w.textContent="git checkout "+t.oid.substring(0,12)}(t),this.renderProgress(e,n),window.location.hash=0==e?"":t.id,s.scroll(0,0),y.scroll(0,0),v.open=!1,r.open=!1,p.disabled=!1,this.totalCommits=n,this.requestedLoadComments=!1}openFile(t,e,n,i){x.style.display="",function(t,e,n){if(I.textContent=e,E.innerHTML=n+'<div class="overscroll"/>',!(e in t.diff))return;const i=t.diff[e].changed_lines;for(const t of E.querySelectorAll(".line"))t.dataset.line&&i.includes(parseInt(t.dataset.line))&&t.classList.add("d-a")}(t,e,n);const o=E.querySelector(`.line[data-line="${i}"]`);if(o){o.scrollIntoView();const t=E.getBoundingClientRect(),e=t.y+t.height/2,n=o.getBoundingClientRect(),i=n.y+n.height/2;E.scrollTop+=i-e}else E.scroll(0,0)}closeFile(){x.style.display="none"}setLoading(t){o.style.display=t?"":"none",t||document.body.classList.remove("loading")}setCommentsCount(t){B(t)}loadComments(t){!function(t){d.style.display="",C.style.display="none",c.textContent=0==t.length?"No Comments Yet":"";for(let e of t){let t=document.createElement("div");t.classList.add("comment");let n=document.createElement("span");n.classList.add("diminished"),n.textContent="(Comment #"+e.id+") ";let i=document.createElement("bdi");i.classList.add("author"),i.textContent=e.author;let o=document.createElement("span");o.classList.add("diminished"),o.textContent=" @ "+new Date(e.date).toLocaleString()+":";let s=document.createElement("p");s.innerText=e.body,t.appendChild(n),t.appendChild(i),t.appendChild(o),t.appendChild(s),c.appendChild(t)}}(t),T()}notifyCommentSubmitted(t){p.disabled=!1,t?(C.style.display="",C.scrollIntoView({block:"nearest",behavior:"smooth"}),h.value=""):alert("Sorry, failed to submit comment")}renderProgress(t,e){if(null==this.totalCommits||e!=this.totalCommits){const t='<span class="dot"></span>'.repeat(e);F.innerHTML=t}null!=this.commitIndex&&F.children[this.commitIndex].classList.remove("active"),F.children[t].classList.add("active"),this.commitIndex=t;let n=1;if(t<e-1){const e=F.children[t].getBoundingClientRect().right+4,i=P.getBoundingClientRect();n=(e-i.left)/i.width}q.style.width=100*n+"%"}};new class{constructor(t,e,n){this.view=t,this.repo=e,this.comments=n,this.commitIndex=0,this.loading=!0,this.navigationCount=0,this.view.sendEvent=this.on.bind(this)}async start(t){try{await this.repo.loadIndex()}catch{return void this.view.reportError("Critical: Loading failed, please refresh the page")}await this.loadCommit(this.repo.getCommitIndexFromId(t))}async on(t){if(!this.loading)switch(t.type){case i.Home:case i.NextCommit:case i.PrevCommit:case i.SeekCommit:case i.ChangeHash:await this.onNavigationEvent(t);break;case i.OpenFile:if(this.commit){let e=this.repo.getObject(this.commit.tree[t.file]);this.view.openFile(this.commit,t.file,e,t.line)}break;case i.CloseFile:this.view.closeFile();break;case i.LoadComments:if(this.commit){let t=this.navigationCount,e=await this.comments.getComments(this.commit.id);if(t!=this.navigationCount)return;this.view.loadComments(e)}break;case i.PostComment:if(this.commit){let e=this.navigationCount,n=await this.comments.postComment(this.commit.id,t.name,t.email,t.body);if(e!=this.navigationCount)return;this.view.notifyCommentSubmitted(n)}}}async onNavigationEvent(t){let e=0;switch(t.type){case i.Home:e=0;break;case i.NextCommit:this.commitIndex<this.repo.totalCommits-1&&(e=this.commitIndex+1);break;case i.PrevCommit:this.commitIndex>0&&(e=this.commitIndex-1);break;case i.SeekCommit:t.commit>=0&&t.commit<this.repo.totalCommits&&(e=t.commit);break;case i.ChangeHash:e=this.repo.getCommitIndexFromId(t.commitId)}e!=this.commitIndex&&this.loadCommit(e)}async loadCommit(t){this.loading=!0,this.navigationCount++,this.view.setLoading(!0),this.commitIndex=t;try{this.commit=await this.repo.getCommitByIndex(t)}catch{return void this.view.reportError("Critical: Loading failed, please refresh the page")}this.view.loadCommit(this.commit,t,this.repo.totalCommits),this.loading=!1;let e=this.navigationCount,n=await this.comments.getCommentCount(this.commit.id);e==this.navigationCount&&this.view.setCommentsCount(n)}}(N,H,_).start(window.location.hash.substr(1))}]);