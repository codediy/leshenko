{"commits": [{"oid": "325bca5eec54492694d94c9a9e2c6d77c786d4f0", "id": "generic-refs", "title": "tag: Generalize HEAD to refs", "message": "<p>As part of implementing <code>tag</code>, we'll generalize the way we handle HEAD. If you think about it, HEAD and tags are similar. They are both ways for ugit to attach a name to an OID. In case of HEAD, the name is hardcoded by ugit; in case of tags, the name will be provided by the user. It makes sense to handle them similarly in <em>data.py</em>.</p>\n<p>In <em>data.py</em>, let's extend the function <code>set_HEAD</code> and <code>get_HEAD</code> to <code>update_ref</code> and <code>get_ref</code>. \"Ref\" is a short of reference, and that's the name Git uses. The function will now accept the name of the ref and write/read it as a file under <em>.ugit</em> directory. Logically, a ref is a named pointer to an object.</p>\n<p>The important change is in <em>data.py</em>. The rest of the changes just rename some functions:</p>\n<pre><code>- get_HEAD ()    -&gt;   get_ref (&#39;HEAD&#39;)\n- set_HEAD (oid) -&gt;   update_ref (&#39;HEAD&#39;, oid)</code></pre>\n<p>Note that we didn't change any behaviour of ugit here, this is purely refactoring.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [77, 86, 94], "hunks": [{"title": "@@ -74,7 +74,7 @@ def read_tree (tree_oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"74\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"76\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"77\"><span class=\"d-s\">- </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"77\"><span class=\"d-s\">+ </span>    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span></code></pre></div>\n"}, {"title": "@@ -83,7 +83,7 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"83\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"86\"><span class=\"d-s\">- </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"86\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span></code></pre></div>\n"}, {"title": "@@ -91,7 +91,7 @@ def commit (message):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"91\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span>    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"94\"><span class=\"d-s\">- </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"94\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"96\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"97\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [85, 101], "hunks": [{"title": "@@ -82,7 +82,7 @@ def commit (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"82\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"83\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"85\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"85\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\"><span class=\"d-s\">  </span>    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"87\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -98,5 +98,5 @@ def checkout (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"101\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_HEAD</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"101\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [13, 14, 18, 19, 20], "hunks": [{"title": "@@ -10,14 +10,14 @@ def init ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"10\"><span class=\"d-s\">  </span>    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"13\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">set_HEAD</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"13\"><span class=\"d-s\">- </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"13\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\"><span class=\"d-s\">  </span>        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"17\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"18\"><span class=\"d-s\">- </span><span class=\"k\">def</span> <span class=\"nf\">get_HEAD</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"18\"><span class=\"d-s\">- </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"18\"><span class=\"d-s\">- </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/HEAD&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"18\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"19\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"20\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\"><span class=\"d-s\">  </span>            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"22\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "c20f107cf484420b36c374a1a493a79996be8dce", "ugit/cli.py": "7c2b7aa350d97a9cae4e08779005c8de6f86028a", "ugit/data.py": "ea2408397f5b0d93f803e61f93cbac9e75fbefa1"}}, {"oid": "e87b1c8edd620a530c1a14c40bca7909aa2c923e", "id": "tag-create-ref", "title": "tag: Create the tag ref", "message": "<p>After we've implemented refs in the previous change, it's time to create a ref when the user creates a tag.</p>\n<p><code>create_tag</code> now calls update_ref with the tag name to actually create the tag.</p>\n<p>For namespacing purposes, we'll put all tags under <em>refs/tags/</em>. That is, if the user creates <em>my-cool-commit</em> tag, we'll create <em>refs/tags/my-cool-commit</em> ref to point to the desired OID.</p>\n<p>Then we'll update <em>data.py</em> to handle this \"namespaced\" ref. Since we can't have a <em>/</em> in the file name, we'll create directories for it. Now if a ref <em>ref/tags/sometag</em> is created, it will be places under <em>.ugit/ref/tags</em> in a file named <em>sometag</em>.</p>\n<p>To verify that this code works, you can run:</p>\n<pre><code>$ ugit tag test</code></pre>\n<p>And make sure that the tag points to HEAD:</p>\n<pre><code>$ cat .ugit/refs/tags/test\n$ cat .ugit/HEAD</code></pre>\n<p>The last two commands should give the same output.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [98], "hunks": [{"title": "@@ -95,8 +95,7 @@ def checkout (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"95\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"96\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"97\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"98\"><span class=\"d-s\">- </span>    <span class=\"c1\"># TODO Actually create the tag</span>\n</span><span class=\"line d-r\" data-line=\"98\"><span class=\"d-s\">- </span>    <span class=\"k\">pass</span>\n</span><span class=\"line d-a\" data-line=\"98\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"101\"><span class=\"d-s\">  </span><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [14, 15, 16, 21, 22, 23], "hunks": [{"title": "@@ -11,13 +11,16 @@ def init ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"11\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"12\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"13\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"14\"><span class=\"d-s\">- </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"14\"><span class=\"d-s\">+ </span>    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"15\"><span class=\"d-s\">+ </span>    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"16\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\"><span class=\"d-s\">  </span>        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"20\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"21\"><span class=\"d-s\">- </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"21\"><span class=\"d-s\">- </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"21\"><span class=\"d-s\">+ </span>    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"22\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"23\"><span class=\"d-s\">+ </span>        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"24\"><span class=\"d-s\">  </span>            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"25\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "4079bfd4b864d8fa3b064574ad6804a30ddc2f9c", "ugit/cli.py": "7c2b7aa350d97a9cae4e08779005c8de6f86028a", "ugit/data.py": "78243be01a29112bc37b4a4e74da4ce8ed8c424c"}}, {"oid": "2c44553457960c34f1494bb7dc2604beb1a12704", "id": "resolve-refs-argparse", "title": "tag: Resolve name to oid in argparse", "message": "<p>It nice that we can create tags, but now let's actually make them usable from the CLI.</p>\n<p>In <em>base.py</em>, we'll create <code>get_oid</code> to resolve a \"name\" to an OID. A name can either be a ref (in which case <code>get_oid</code> will return the OID that the ref points to) or an OID (in which case <code>get_oid</code> will just return that same OID).</p>\n<p>Next, we'll modify the argument parser in <em>cli.py</em> to call <code>get_oid</code> on all arguments which are expected to be an OID. This way we can pass a ref there instead of an OID.</p>\n<p>At this point we can do something like:</p>\n<pre><code>$ ugit tag mytag d8d43b0e3a21df0c845e185d08be8e4028787069\n$ ugit log refs/tags/mytag\n# Will print log of commits starting at d8d43b0e...\n$ ugit checkout refs/tags/mytag\n# Will checkout commit d8d43b0e...\netc...</code></pre>\n", "diff": {"ugit/base.py": {"changed_lines": [122, 123, 124, 125], "hunks": [{"title": "@@ -119,5 +119,9 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"119\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"122\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"123\"><span class=\"d-s\">+ </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"125\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"126\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"127\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [20, 21, 31, 38, 46, 50, 55], "hunks": [{"title": "@@ -17,6 +17,8 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"17\"><span class=\"d-s\">  </span>    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\"><span class=\"d-s\">  </span>    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"20\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line d-a\" data-line=\"21\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"22\"><span class=\"d-s\">  </span>    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\"><span class=\"d-s\">  </span>    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -26,14 +28,14 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"28\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"29\"><span class=\"d-s\">  </span>    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\"><span class=\"d-s\">  </span>    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"31\"><span class=\"d-s\">- </span>    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"31\"><span class=\"d-s\">+ </span>    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"33\"><span class=\"d-s\">  </span>    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\"><span class=\"d-s\">  </span>    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"36\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\"><span class=\"d-s\">  </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"38\"><span class=\"d-s\">- </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"38\"><span class=\"d-s\">+ </span>    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"40\"><span class=\"d-s\">  </span>    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\"><span class=\"d-s\">  </span>    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -41,16 +43,16 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"43\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"44\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"46\"><span class=\"d-s\">- </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"46\"><span class=\"d-s\">+ </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"48\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"50\"><span class=\"d-s\">- </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"50\"><span class=\"d-s\">+ </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"55\"><span class=\"d-s\">- </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "758df1cb3874811350b739094689b88fe6be7af0", "ugit/cli.py": "a9ba863b5703ab2165f8b1ecbfdc832acb065de0", "ugit/data.py": "78243be01a29112bc37b4a4e74da4ce8ed8c424c"}}, {"oid": "53e659c9bcfb155caada7127e0ca7fe2e6359ce6", "id": "search-ref-directories", "title": "base: Try different directories when searching for a ref", "message": "<p>In the previous change, you might have noticed that we need to spell out the full name of a tag (Like <em>refs/tags/mytag</em>). This isn't very convenient, we would like to have shorter command names. For example, if we've created \"mytag\" tag, we should be able to do <code>ugit log mytag</code> rather than having to specify <code>ugit log refs/tags/mytag</code>.</p>\n<p>We'll extend <code>get_oid</code> to search in different ref subdirectories when resolving a name. We'll search in:</p>\n<ul>\n<li>Root (<em>.ugit</em>): This way we can specify <code>refs/tags/mytag</code></li>\n<li><em>.ugit/refs</em>: This way we can specify <code>tags/mytag</code></li>\n<li><em>.ugit/refs/tags</em>: This way we can specify <code>mytag</code></li>\n<li><em>.ugit/refs/heads</em>: This will be needed for a future change</li>\n</ul>\n<p>If we find the requested name in any of the directories, return it. Otherwise assume that the name is an OID.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [4, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140], "hunks": [{"title": "@@ -1,6 +1,7 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line d-a\" data-line=\"4\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span></code></pre></div>\n"}, {"title": "@@ -120,7 +121,23 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"123\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"124\"><span class=\"d-s\">- </span>    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line d-a\" data-line=\"125\"><span class=\"d-s\">+ </span>    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line d-a\" data-line=\"126\"><span class=\"d-s\">+ </span>        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"127\"><span class=\"d-s\">+ </span>        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"128\"><span class=\"d-s\">+ </span>        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"129\"><span class=\"d-s\">+ </span>        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line d-a\" data-line=\"130\"><span class=\"d-s\">+ </span>    <span class=\"p\">]</span>\n</span><span class=\"line d-a\" data-line=\"131\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"132\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"133\"><span class=\"d-s\">+ </span>            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"134\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"135\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line d-a\" data-line=\"136\"><span class=\"d-s\">+ </span>    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"137\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"138\"><span class=\"d-s\">+ </span>        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line d-a\" data-line=\"139\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"140\"><span class=\"d-s\">+ </span>    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"141\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"142\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"143\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "f88c05c8115bfefceb684347816ee67ac0e84ab9", "ugit/cli.py": "a9ba863b5703ab2165f8b1ecbfdc832acb065de0", "ugit/data.py": "78243be01a29112bc37b4a4e74da4ce8ed8c424c"}}, {"oid": "656bc7cc13b2b0485da0bd2d26a19ae8204e12c9", "id": "make-head-default", "title": "cli: pass HEAD by default in argparse", "message": "<p>First, make \"@\" be an alias for HEAD. (Implemented in <code>get_oid</code>)</p>\n<p>Second, do a little refactoring in <em>cli.py</em>. Some commands accept an optional OID argument and if the argument isn't provided it defaults to HEAD. For example <code>git log</code> can get an OID to start logging from, but by default it logs all commits before HEAD.</p>\n<p>Instead of having each command implement this logic, let's just make \"@\" (HEAD) be the default value for those commands. The relevant commands at this stage at <code>log</code> and <code>tag</code>. More will follow.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [124, 125], "hunks": [{"title": "@@ -121,6 +121,8 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"123\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line d-a\" data-line=\"125\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"126\"><span class=\"d-s\">  </span>    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"127\"><span class=\"d-s\">  </span>    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"128\"><span class=\"d-s\">  </span>        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [46, 55, 87, 103], "hunks": [{"title": "@@ -43,7 +43,7 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"43\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"44\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\"><span class=\"d-s\">  </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"46\"><span class=\"d-s\">- </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"46\"><span class=\"d-s\">+ </span>    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"48\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\"><span class=\"d-s\">  </span>    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -52,7 +52,7 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"52\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"55\"><span class=\"d-s\">- </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"55\"><span class=\"d-s\">+ </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}, {"title": "@@ -84,7 +84,7 @@ def commit (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"84\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"85\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"86\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"87\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"87\"><span class=\"d-s\">+ </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span>    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -100,5 +100,4 @@ def checkout (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"101\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"102\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"103\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"103\"><span class=\"d-s\">- </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "0af4f4b15168a8f7dedcf0c6e88318fa6c7f2e9c", "ugit/cli.py": "a5a2030a47d4aeb199985fcc096556048485adf6", "ugit/data.py": "78243be01a29112bc37b4a4e74da4ce8ed8c424c"}}, {"oid": "19bcfea29a813c8012e755fed78fe3fc8f1534fd", "id": "k-print-refs", "title": "k: Print refs", "message": "<p>Now that we have refs and a potentially branching commit history, it's a good idea to create a visualization tool to see all the mess that we've created.</p>\n<p>The visualization tool will draw all refs and all the commits pointed by the refs.</p>\n<p>Our command to run the tool will be called <code>ugit k</code>, similar to <code>gitk</code> (which is a graphical visualization tool for Git).</p>\n<p>We'll create a new <code>k</code> command in <em>cli.py</em>. We'll create <code>iter_refs</code> which is a generator which will iterate on all available refs (it will return HEAD from the ugit root directory and everything under <em>.ugit/refs</em>). As a first step, let's just print all refs when running <code>k</code>.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [57, 58, 59, 107, 108, 109, 110, 111, 112], "hunks": [{"title": "@@ -54,6 +54,9 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"54\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"57\"><span class=\"d-s\">+ </span>    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"60\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}, {"title": "@@ -101,3 +104,9 @@ def checkout (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"104\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"105\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"107\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"108\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"109\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span>    <span class=\"c1\"># TODO visualize refs</span>\n</span></code></pre></div>\n"}]}, "ugit/data.py": {"changed_lines": [27, 28, 29, 30, 31, 32, 33, 34, 35, 36], "hunks": [{"title": "@@ -24,6 +24,16 @@ def get_ref (ref):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"24\"><span class=\"d-s\">  </span>            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"25\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"26\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"27\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line d-a\" data-line=\"28\"><span class=\"d-s\">+ </span>    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line d-a\" data-line=\"29\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"30\"><span class=\"d-s\">+ </span>        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"31\"><span class=\"d-s\">+ </span>        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"32\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"33\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"34\"><span class=\"d-s\">+ </span>        <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"35\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"36\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"37\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"38\"><span class=\"d-s\">  </span>    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"39\"><span class=\"d-s\">  </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "0af4f4b15168a8f7dedcf0c6e88318fa6c7f2e9c", "ugit/cli.py": "2c19ade74bad89c173ecafa2086886071b9ae51e", "ugit/data.py": "38d6ddce21692b5345aa905c3f979b4c3cbab9b9"}}, {"oid": "deaa255d4b8e86a33f47bedcfef5fbfa3c41ff0b", "id": "k-iterate-commits", "title": "k: Iterate commits and parents", "message": "<p>In addition to printing the refs, we'll also print all OIDs that are reachable from those refs. We'll create <code>iter_commits_and_parents</code>, which is a generator that returns all commits that it can reach from a given set of OIDs.</p>\n<p>Note that <code>iter_commits_and_parents</code> will return an OID once, even if it's reachable from mupltiple refs. Here, for example:</p>\n<pre><code>o&lt;----o&lt;----o&lt;----o&lt;----@&lt;----@&lt;----@\n^                  \\                ^\nfirst commit        -&lt;--$&lt;----$     refs/tags/tag1\n                              ^\n                              refs/tags/tag2</code></pre>\n<p>We can reach the first commit by following the parents of <em>tag1</em> or by following the parents of <em>tag2</em>. Yet if we call <code>iter_commits_and_parents({tag1, tag2})</code>, the first commit will be yielded only once. This property will be useful later.</p>\n<p>(Note that nothing is visialized yet, we're preparing for that.)</p>\n", "diff": {"ugit/base.py": {"changed_lines": [123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137], "hunks": [{"title": "@@ -120,6 +120,21 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"120\"><span class=\"d-s\">  </span>    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"123\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"125\"><span class=\"d-s\">+ </span>    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"126\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"127\"><span class=\"d-s\">+ </span>    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"128\"><span class=\"d-s\">+ </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">pop</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"129\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"130\"><span class=\"d-s\">+ </span>            <span class=\"k\">continue</span>\n</span><span class=\"line d-a\" data-line=\"131\"><span class=\"d-s\">+ </span>        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"132\"><span class=\"d-s\">+ </span>        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line d-a\" data-line=\"133\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"134\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"135\"><span class=\"d-s\">+ </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"136\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"137\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"138\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\"><span class=\"d-s\">  </span>    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [110, 113, 114, 115, 116, 117, 118, 119, 120], "hunks": [{"title": "@@ -107,6 +107,15 @@ def tag (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"107\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"108\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"109\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"110\"><span class=\"d-s\">+ </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"111\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"112\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"113\"><span class=\"d-s\">+ </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"114\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"117\"><span class=\"d-s\">+ </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"118\"><span class=\"d-s\">+ </span>        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"119\"><span class=\"d-s\">+ </span>            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Parent&#39;</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"120\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>    <span class=\"c1\"># TODO visualize refs</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "d22b0b24aeb441898d99d109da1068365e5dff73", "ugit/cli.py": "f52e044c33f4e55f83b77104804b8314a309e3e2", "ugit/data.py": "38d6ddce21692b5345aa905c3f979b4c3cbab9b9"}}, {"oid": "f278e046813c3fb1de0f45ce6ffd7d7599079845", "id": "k-render-graph", "title": "k: Render graph", "message": "<p><code>k</code> is supposed to be a visualization tool, but so far we've just printed a bunch of OIDs... Now comes the visualization part!</p>\n<p>There's a convenient file format called \"dot\" that can describe a graph. This is a textual format. We'll generate a graph of all commits and refs in dot format and then visualize it using the \"dot\" utility that comes with Graphviz.</p>\n<p>(If you're unfamiliar with dot or Graphviz please look it up online.)</p>\n<p>The graph will contains a node for each commit, that points to the parent commit. The graph will also contain a node for each ref, which points to the relevant commit.</p>\n<p>At this point, <code>ugit k</code> is fully functional and I encourage you to play with it. Create a crazy branching history and a bunch of tags and see for yourself that <code>ugit k</code> can draw all that visually.</p>\n", "diff": {"ugit/cli.py": {"changed_lines": [2, 111, 112, 115, 116, 121, 123, 124, 125, 126, 128, 129, 130, 131], "hunks": [{"title": "@@ -1,4 +1,5 @@", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line d-a\" data-line=\"2\"><span class=\"d-s\">+ </span><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span></code></pre></div>\n"}, {"title": "@@ -107,15 +108,24 @@ def tag (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"108\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"109\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"110\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"111\"><span class=\"d-s\">+ </span>    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"113\"><span class=\"d-s\">  </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"114\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line d-r\" data-line=\"115\"><span class=\"d-s\">- </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span>        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\"><span class=\"d-s\">  </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"118\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"119\"><span class=\"d-s\">  </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"120\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"121\"><span class=\"d-s\">- </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"121\"><span class=\"d-s\">+ </span>        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"123\"><span class=\"d-s\">- </span>            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Parent&#39;</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"123\"><span class=\"d-s\">+ </span>            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"125\"><span class=\"d-s\">+ </span>    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line d-a\" data-line=\"126\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"128\"><span class=\"d-s\">- </span>    <span class=\"c1\"># TODO visualize refs</span>\n</span><span class=\"line d-a\" data-line=\"128\"><span class=\"d-s\">+ </span>    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line d-a\" data-line=\"129\"><span class=\"d-s\">+ </span>            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line d-a\" data-line=\"130\"><span class=\"d-s\">+ </span>            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"131\"><span class=\"d-s\">+ </span>        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "d22b0b24aeb441898d99d109da1068365e5dff73", "ugit/cli.py": "0b9d2c563e690ea7825ef485670a89e3766eafb2", "ugit/data.py": "38d6ddce21692b5345aa905c3f979b4c3cbab9b9"}}, {"oid": "09aa76f5f9ae2aee2c37209f4ae72783b7dbba30", "id": "log-generic-iteration", "title": "log: Use iter_commits_and_parents", "message": "<p>Refactoring ahead! Since we have <code>iter_commits_and_parents</code> from <code>k</code>, let's also use this function in <code>log</code>. We'll need to adjust it a bit to use <code>collections.deque</code> instead of a set so that the order of commits is deterministic.</p>\n<p>This generalization might seem unneeded at this point, but it will be useful later. (Note for the advanced folks: When we implement merge commits that have multiple parents, this generic way to iterate will come in handy.)</p>\n", "diff": {"ugit/base.py": {"changed_lines": [6, 124, 128, 135, 136], "hunks": [{"title": "@@ -3,7 +3,7 @@ import operator", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"3\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"d-s\">  </span><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"6\"><span class=\"d-s\">- </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line d-a\" data-line=\"6\"><span class=\"d-s\">+ </span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"8\"><span class=\"d-s\">  </span><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span></code></pre></div>\n"}, {"title": "@@ -121,18 +121,19 @@ def get_commit (oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"121\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"122\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"123\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"124\"><span class=\"d-s\">- </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"124\"><span class=\"d-s\">+ </span>    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\"><span class=\"d-s\">  </span>    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"126\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"127\"><span class=\"d-s\">  </span>    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line d-r\" data-line=\"128\"><span class=\"d-s\">- </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">pop</span> <span class=\"p\">()</span>\n</span><span class=\"line d-a\" data-line=\"128\"><span class=\"d-s\">+ </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"129\"><span class=\"d-s\">  </span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"130\"><span class=\"d-s\">  </span>            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"131\"><span class=\"d-s\">  </span>        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"132\"><span class=\"d-s\">  </span>        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"133\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"134\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-r\" data-line=\"135\"><span class=\"d-s\">- </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"135\"><span class=\"d-s\">+ </span>        <span class=\"c1\"># Return parent next</span>\n</span><span class=\"line d-a\" data-line=\"136\"><span class=\"d-s\">+ </span>        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">appendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"138\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"139\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [91], "hunks": [{"title": "@@ -88,16 +88,13 @@ def commit (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"88\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"89\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"90\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-r\" data-line=\"91\"><span class=\"d-s\">- </span>    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line d-r\" data-line=\"91\"><span class=\"d-s\">- </span>    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line d-a\" data-line=\"91\"><span class=\"d-s\">+ </span>    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"92\"><span class=\"d-s\">  </span>        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"94\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"96\"><span class=\"d-s\">  </span>        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-r\" data-line=\"98\"><span class=\"d-s\">- </span>        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line d-r\" data-line=\"98\"><span class=\"d-s\">- </span>\n</span><span class=\"line\" data-line=\"98\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "5dc06f7ddc9dbc08d171269bc4a5b4e17f4ce5f4", "ugit/cli.py": "68e062908c9f960abb419bdacd3a167eb3cc53a6", "ugit/data.py": "38d6ddce21692b5345aa905c3f979b4c3cbab9b9"}}, {"oid": "7ecd98fd79ad3bff7ec265f4296fc97cde35794b", "id": "create-new-branch", "title": "branch: Create new branch", "message": "<p>Tags were an improvement since they freed us from the burden of remembering OIDs directly. But they are still somewhat inconvenient, since they are static. Let me illustrate:</p>\n<pre><code>o-----o-----o-----o-----o-----o-----o\n                   \\                ^\n                    ----o-----o  tag2,HEAD\n                              ^\n                           tag1</code></pre>\n<p>If we have the above situation, we can easily flip between <em>tag1</em> and <em>tag2</em> with <code>checkout</code>. But what happens if we do</p>\n<ul>\n<li><code>ugit checkout tag2</code></li>\n<li>Make some changes</li>\n<li><code>ugit commit</code>?</li>\n</ul>\n<p>Now it looks like this:</p>\n<pre><code>o-----o-----o-----o-----o-----o-----o-----o\n                   \\                ^     ^\n                    ----o-----o  tag2     HEAD\n                              ^\n                           tag1</code></pre>\n<p>The upper branch has advanced, but <em>tag2</em> still points to the previous commit. This is by design, since tags are supposed to just name a specific OID. So if we want to remember the new HEAD position we need to create another tag.</p>\n<p>But now let's create a ref that will \"move forward\" as the branch grows. Just like we have <code>ugit tag</code>, we'll create <code>ugit branch</code> that will point a branch to a specific OID. This time the ref will be created under <em>refs/heads</em>.</p>\n<p>At this stage, <code>branch</code> doesn't look any different from <code>tag</code> (The only difference is that the branch is created under <em>ref/heads</em> rather that <em>ref/tags</em>). But the magic will happen once we try to <code>checkout</code> a branch.</p>\n<p>So far when we checkout anything we update HEAD to point to the OID that we've just checked out. But if we checkout a branch by name, we'll do something different, we will update HEAD to point to the <strong>name of the branch</strong>! Assume that we have a branch here:</p>\n<pre><code>o-----o-----o-----o-----o-----o-----o\n                   \\                ^\n                    ----o-----o tag2,branch2\n                              ^\n                           tag1</code></pre>\n<p>Running <code>ugit checkout branch2</code> will create the following situation:</p>\n<pre><code>o-----o-----o-----o-----o-----o-----o\n                   \\                ^\n                    ----o-----o tag2,branch2 &lt;--- HEAD\n                              ^\n                           tag1</code></pre>\n<p>You see? HEAD points to <em>branch2</em> rather then the OID of the commit directly. Now if we create another commit, ugit will update HEAD to point to the latest commit (just like it does every time) but as a side effect it will also update <em>branch2</em> to point to the latest commit.</p>\n<pre><code>o-----o-----o-----o-----o-----o-----o-----o\n                   \\                ^     ^\n                    ----o-----o  tag2     branch2 &lt;--- HEAD\n                              ^\n                           tag1</code></pre>\n<p>This way, if we checkout a branch and create some commits on top of it, the ref will always point to the latest commit.</p>\n<p>But right now HEAD (or any ref for that matter) may only point to an OID. It can't point to another ref, like I described above. So our next step would be to implement this concept. To mirror Git's terminology, we will call a ref that points to another ref a \"symbolic ref\". Please see the next change for an implementation of symbolic refs.</p>\n", "diff": {"ugit/base.py": {"changed_lines": [102, 103, 104, 105], "hunks": [{"title": "@@ -99,6 +99,10 @@ def create_tag (name, oid):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"99\"><span class=\"d-s\">  </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"101\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"102\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"103\"><span class=\"d-s\">+ </span>    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"104\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"105\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"106\"><span class=\"d-s\">  </span><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"107\"><span class=\"d-s\">  </span>\n</span></code></pre></div>\n"}]}, "ugit/cli.py": {"changed_lines": [58, 59, 60, 61, 62, 112, 113, 114, 115, 116], "hunks": [{"title": "@@ -55,6 +55,11 @@ def parse_args ():", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"55\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\"><span class=\"d-s\">  </span>    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"58\"><span class=\"d-s\">+ </span>    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"59\"><span class=\"d-s\">+ </span>    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"60\"><span class=\"d-s\">+ </span>    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"61\"><span class=\"d-s\">+ </span>    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"62\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"63\"><span class=\"d-s\">  </span>    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\"><span class=\"d-s\">  </span>    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span></code></pre></div>\n"}, {"title": "@@ -104,6 +109,11 @@ def tag (args):", "diff": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"109\"><span class=\"d-s\">  </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\"><span class=\"d-s\">  </span>\n</span><span class=\"line\" data-line=\"111\"><span class=\"d-s\">  </span>\n</span><span class=\"line d-a\" data-line=\"112\"><span class=\"d-s\">+ </span><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line d-a\" data-line=\"113\"><span class=\"d-s\">+ </span>    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"114\"><span class=\"d-s\">+ </span>    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line d-a\" data-line=\"115\"><span class=\"d-s\">+ </span>\n</span><span class=\"line d-a\" data-line=\"116\"><span class=\"d-s\">+ </span>\n</span><span class=\"line\" data-line=\"117\"><span class=\"d-s\">  </span><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"118\"><span class=\"d-s\">  </span>    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span></code></pre></div>\n"}]}}, "tree": {".gitignore": "567994ceb193ad3c00ebec195c7a702c2223826e", "setup.py": "9c0db12ec5a6601de28ac37b24136054415e1d96", "ugit/base.py": "7a24597f4f59238f28c455fd75abff7efbad6a4c", "ugit/cli.py": "177117f2367f2d90a802260572662cf3661b5c08", "ugit/data.py": "38d6ddce21692b5345aa905c3f979b4c3cbab9b9"}}], "objects": {"c20f107cf484420b36c374a1a493a79996be8dce": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"98\">    <span class=\"c1\"># TODO Actually create the tag</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"k\">pass</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"115\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "7c2b7aa350d97a9cae4e08779005c8de6f86028a": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">\n</span><span class=\"line\" data-line=\"62\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"64\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"81\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"87\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"91\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">\n</span><span class=\"line\" data-line=\"93\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"97\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"101\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "ea2408397f5b0d93f803e61f93cbac9e75fbefa1": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"9\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">\n</span><span class=\"line\" data-line=\"24\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"28\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"30\">\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">first_null</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">index</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[:</span><span class=\"n\">first_null</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[</span><span class=\"n\">first_null</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">:]</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "4079bfd4b864d8fa3b064574ad6804a30ddc2f9c": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"98\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"112\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"114\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "78243be01a29112bc37b4a4e74da4ce8ed8c424c": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"9\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"24\">            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">\n</span><span class=\"line\" data-line=\"35\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"37\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"38\">\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">first_null</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">index</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[:</span><span class=\"n\">first_null</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[</span><span class=\"n\">first_null</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">:]</span>\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"44\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "758df1cb3874811350b739094689b88fe6be7af0": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"13\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"16\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"19\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"21\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"22\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"28\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"35\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"38\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"45\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"49\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"50\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"51\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"52\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"53\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"55\">\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"59\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"60\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"62\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"63\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"67\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"71\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"79\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"98\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"112\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"114\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"115\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"116\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"127\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "a9ba863b5703ab2165f8b1ecbfdc832acb065de0": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "f88c05c8115bfefceb684347816ee67ac0e84ab9": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"16\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"17\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"21\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"25\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"30\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"49\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"115\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"126\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"127\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"129\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"130\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"131\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"132\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"133\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">\n</span><span class=\"line\" data-line=\"135\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"136\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"138\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"139\">\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "0af4f4b15168a8f7dedcf0c6e88318fa6c7f2e9c": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"16\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"17\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"21\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"25\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"30\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"49\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"115\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"127\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"129\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"130\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"132\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"133\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"134\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"135\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"138\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"143\">\n</span><span class=\"line\" data-line=\"144\">\n</span><span class=\"line\" data-line=\"145\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"146\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "a5a2030a47d4aeb199985fcc096556048485adf6": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"58\">\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"66\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"71\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"89\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "2c19ade74bad89c173ecafa2086886071b9ae51e": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\">\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"96\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">    <span class=\"c1\"># TODO visualize refs</span>\n</span></code></pre></div>\n", "38d6ddce21692b5345aa905c3f979b4c3cbab9b9": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"3\">\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"n\">GIT_DIR</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;.ugit&#39;</span>\n</span><span class=\"line\" data-line=\"6\">\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"9\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"11\">\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\"><span class=\"k\">def</span> <span class=\"nf\">update_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"14\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;w&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"17\">        <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\"><span class=\"k\">def</span> <span class=\"nf\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">ref_path</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"22\">    <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"23\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">ref_path</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"24\">            <span class=\"k\">return</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">strip</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">\n</span><span class=\"line\" data-line=\"27\"><span class=\"k\">def</span> <span class=\"nf\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">refs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"29\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/refs/&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"30\">        <span class=\"n\">root</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">GIT_DIR</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">        <span class=\"n\">refs</span><span class=\"o\">.</span><span class=\"n\">extend</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"k\">for</span> <span class=\"n\">refname</span> <span class=\"ow\">in</span> <span class=\"n\">refs</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"34\">        <span class=\"k\">yield</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">type_</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span> <span class=\"o\">+</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"40\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">out</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"41\">        <span class=\"n\">out</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\"><span class=\"k\">def</span> <span class=\"nf\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">GIT_DIR</span><span class=\"si\">}</span><span class=\"s1\">/objects/</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">first_null</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">index</span> <span class=\"p\">(</span><span class=\"sa\">b</span><span class=\"s1\">&#39;</span><span class=\"se\">\\x00</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[:</span><span class=\"n\">first_null</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"p\">[</span><span class=\"n\">first_null</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">:]</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"k\">if</span> <span class=\"n\">expected</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">        <span class=\"k\">assert</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"n\">expected</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Expected </span><span class=\"si\">{</span><span class=\"n\">expected</span><span class=\"si\">}</span><span class=\"s1\">, got </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">content</span>\n</span></code></pre></div>\n", "d22b0b24aeb441898d99d109da1068365e5dff73": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"16\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"17\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"21\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"25\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"30\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"49\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"115\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">pop</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"129\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"130\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"132\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"139\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"140\">\n</span><span class=\"line\" data-line=\"141\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"142\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"143\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"144\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"145\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"146\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"148\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"149\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"150\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"151\">\n</span><span class=\"line\" data-line=\"152\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"155\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"158\">\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"161\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "f52e044c33f4e55f83b77104804b8314a309e3e2": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"4\">\n</span><span class=\"line\" data-line=\"5\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"10\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"12\">\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"15\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"16\">\n</span><span class=\"line\" data-line=\"17\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"19\">\n</span><span class=\"line\" data-line=\"20\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"21\">\n</span><span class=\"line\" data-line=\"22\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">\n</span><span class=\"line\" data-line=\"25\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">\n</span><span class=\"line\" data-line=\"29\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">\n</span><span class=\"line\" data-line=\"36\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">\n</span><span class=\"line\" data-line=\"40\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">\n</span><span class=\"line\" data-line=\"48\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">\n</span><span class=\"line\" data-line=\"52\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">\n</span><span class=\"line\" data-line=\"60\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"61\">\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"69\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"70\">\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"73\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"75\">\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"78\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"79\">\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"83\">\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"86\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"87\">\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"90\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"96\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"99\">\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"102\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"114\">\n</span><span class=\"line\" data-line=\"115\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"118\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"119\">            <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Parent&#39;</span><span class=\"p\">,</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">\n</span><span class=\"line\" data-line=\"121\">    <span class=\"c1\"># TODO visualize refs</span>\n</span></code></pre></div>\n", "0b9d2c563e690ea7825ef485670a89e3766eafb2": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"k\">while</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"93\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"97\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"107\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"112\">\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"115\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"122\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"123\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"126\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"127\">\n</span><span class=\"line\" data-line=\"128\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"129\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"130\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n", "5dc06f7ddc9dbc08d171269bc4a5b4e17f4ce5f4": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"16\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"17\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"21\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"25\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"30\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"49\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"106\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"111\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"113\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"115\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"118\">\n</span><span class=\"line\" data-line=\"119\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"120\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"129\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"130\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"131\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"132\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"133\">\n</span><span class=\"line\" data-line=\"134\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"135\">        <span class=\"c1\"># Return parent next</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">appendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">\n</span><span class=\"line\" data-line=\"139\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"140\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"143\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"144\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"145\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"146\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"147\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"148\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"149\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"150\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"151\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"152\">\n</span><span class=\"line\" data-line=\"153\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"154\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"155\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"156\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"157\">\n</span><span class=\"line\" data-line=\"158\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"159\">\n</span><span class=\"line\" data-line=\"160\">\n</span><span class=\"line\" data-line=\"161\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"162\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "68e062908c9f960abb419bdacd3a167eb3cc53a6": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">\n</span><span class=\"line\" data-line=\"61\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">\n</span><span class=\"line\" data-line=\"64\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"65\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"75\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"80\">\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"87\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"91\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"92\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"96\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"100\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"104\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"108\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"109\">\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"111\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"112\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"113\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"114\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"117\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"118\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"119\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"120\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"121\">\n</span><span class=\"line\" data-line=\"122\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"123\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"124\">\n</span><span class=\"line\" data-line=\"125\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"126\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"127\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n", "7a24597f4f59238f28c455fd75abff7efbad6a4c": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">itertools</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">string</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">deque</span><span class=\"p\">,</span> <span class=\"n\">namedtuple</span>\n</span><span class=\"line\" data-line=\"7\">\n</span><span class=\"line\" data-line=\"8\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\">\n</span><span class=\"line\" data-line=\"11\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"o\">=</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">entries</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n</span><span class=\"line\" data-line=\"13\">    <span class=\"k\">with</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">scandir</span> <span class=\"p\">(</span><span class=\"n\">directory</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"14\">        <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">it</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"15\">            <span class=\"n\">full</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">directory</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"16\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"17\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"18\">\n</span><span class=\"line\" data-line=\"19\">            <span class=\"k\">if</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_file</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"20\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;blob&#39;</span>\n</span><span class=\"line\" data-line=\"21\">                <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"22\">                    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"23\">            <span class=\"k\">elif</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">is_dir</span> <span class=\"p\">(</span><span class=\"n\">follow_symlinks</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"24\">                <span class=\"n\">type_</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;tree&#39;</span>\n</span><span class=\"line\" data-line=\"25\">                <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">full</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"26\">            <span class=\"n\">entries</span><span class=\"o\">.</span><span class=\"n\">append</span> <span class=\"p\">((</span><span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"27\">\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\"> </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"29\">                    <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">type_</span>\n</span><span class=\"line\" data-line=\"30\">                    <span class=\"ow\">in</span> <span class=\"nb\">sorted</span> <span class=\"p\">(</span><span class=\"n\">entries</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\"><span class=\"k\">def</span> <span class=\"nf\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"36\">        <span class=\"k\">return</span>\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"k\">for</span> <span class=\"n\">entry</span> <span class=\"ow\">in</span> <span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"39\">        <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">entry</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">        <span class=\"k\">yield</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"41\">\n</span><span class=\"line\" data-line=\"42\">\n</span><span class=\"line\" data-line=\"43\"><span class=\"k\">def</span> <span class=\"nf\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"44\">    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n</span><span class=\"line\" data-line=\"45\">    <span class=\"k\">for</span> <span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">_iter_tree_entries</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"46\">        <span class=\"k\">assert</span> <span class=\"s1\">&#39;/&#39;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"47\">        <span class=\"k\">assert</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s1\">&#39;..&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;.&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">base_path</span> <span class=\"o\">+</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"49\">        <span class=\"k\">if</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;blob&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"50\">            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">path</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"51\">        <span class=\"k\">elif</span> <span class=\"n\">type_</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"52\">            <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">update</span> <span class=\"p\">(</span><span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">path</span><span class=\"si\">}</span><span class=\"s1\">/&#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"53\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"54\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown tree entry </span><span class=\"si\">{</span><span class=\"n\">type_</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</span><span class=\"line\" data-line=\"56\">\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\"><span class=\"k\">def</span> <span class=\"nf\">_empty_current_directory</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"k\">for</span> <span class=\"n\">root</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">filenames</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">walk</span> <span class=\"p\">(</span><span class=\"s1\">&#39;.&#39;</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"60\">        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">filenames</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"61\">            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">relpath</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">root</span><span class=\"si\">}</span><span class=\"s1\">/</span><span class=\"si\">{</span><span class=\"n\">filename</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">            <span class=\"k\">if</span> <span class=\"n\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"63\">                <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"64\">            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">\n</span><span class=\"line\" data-line=\"67\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"68\">    <span class=\"n\">_empty_current_directory</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"69\">    <span class=\"k\">for</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">get_tree</span> <span class=\"p\">(</span><span class=\"n\">tree_oid</span><span class=\"p\">,</span> <span class=\"n\">base_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;./&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">items</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"70\">        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">makedirs</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">),</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"71\">        <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s1\">&#39;wb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"72\">            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"73\">\n</span><span class=\"line\" data-line=\"74\">\n</span><span class=\"line\" data-line=\"75\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"76\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;tree </span><span class=\"si\">{</span><span class=\"n\">write_tree</span> <span class=\"p\">()</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\">    <span class=\"n\">HEAD</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"k\">if</span> <span class=\"n\">HEAD</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"80\">        <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;parent </span><span class=\"si\">{</span><span class=\"n\">HEAD</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"83\">    <span class=\"n\">commit</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"84\">\n</span><span class=\"line\" data-line=\"85\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">(),</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"88\">\n</span><span class=\"line\" data-line=\"89\">    <span class=\"k\">return</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\">\n</span><span class=\"line\" data-line=\"92\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"93\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"94\">    <span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"95\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"s1\">&#39;HEAD&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"96\">\n</span><span class=\"line\" data-line=\"97\">\n</span><span class=\"line\" data-line=\"98\"><span class=\"k\">def</span> <span class=\"nf\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"99\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">\n</span><span class=\"line\" data-line=\"101\">\n</span><span class=\"line\" data-line=\"102\"><span class=\"k\">def</span> <span class=\"nf\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"103\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">update_ref</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span> <span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"104\">\n</span><span class=\"line\" data-line=\"105\">\n</span><span class=\"line\" data-line=\"106\"><span class=\"n\">Commit</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span> <span class=\"p\">(</span><span class=\"s1\">&#39;Commit&#39;</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;message&#39;</span><span class=\"p\">])</span>\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\">\n</span><span class=\"line\" data-line=\"109\"><span class=\"k\">def</span> <span class=\"nf\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"110\">    <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\">    <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">splitlines</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">itertools</span><span class=\"o\">.</span><span class=\"n\">takewhile</span> <span class=\"p\">(</span><span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">truth</span><span class=\"p\">,</span> <span class=\"n\">lines</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"115\">        <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39; &#39;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"116\">        <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"117\">            <span class=\"n\">tree</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"118\">        <span class=\"k\">elif</span> <span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;parent&#39;</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"119\">            <span class=\"n\">parent</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n</span><span class=\"line\" data-line=\"120\">        <span class=\"k\">else</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"121\">            <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown field </span><span class=\"si\">{</span><span class=\"n\">key</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"122\">\n</span><span class=\"line\" data-line=\"123\">    <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">join</span> <span class=\"p\">(</span><span class=\"n\">lines</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"124\">    <span class=\"k\">return</span> <span class=\"n\">Commit</span> <span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">=</span><span class=\"n\">tree</span><span class=\"p\">,</span> <span class=\"n\">parent</span><span class=\"o\">=</span><span class=\"n\">parent</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">\n</span><span class=\"line\" data-line=\"127\"><span class=\"k\">def</span> <span class=\"nf\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"128\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"n\">deque</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"129\">    <span class=\"n\">visited</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"130\">\n</span><span class=\"line\" data-line=\"131\">    <span class=\"k\">while</span> <span class=\"n\">oids</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"132\">        <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">popleft</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"133\">        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">oid</span> <span class=\"ow\">or</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">visited</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"134\">            <span class=\"k\">continue</span>\n</span><span class=\"line\" data-line=\"135\">        <span class=\"n\">visited</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"136\">        <span class=\"k\">yield</span> <span class=\"n\">oid</span>\n</span><span class=\"line\" data-line=\"137\">\n</span><span class=\"line\" data-line=\"138\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"139\">        <span class=\"c1\"># Return parent next</span>\n</span><span class=\"line\" data-line=\"140\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">appendleft</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"141\">\n</span><span class=\"line\" data-line=\"142\">\n</span><span class=\"line\" data-line=\"143\"><span class=\"k\">def</span> <span class=\"nf\">get_oid</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"144\">    <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;@&#39;</span><span class=\"p\">:</span> <span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;HEAD&#39;</span>\n</span><span class=\"line\" data-line=\"145\">\n</span><span class=\"line\" data-line=\"146\">    <span class=\"c1\"># Name is ref</span>\n</span><span class=\"line\" data-line=\"147\">    <span class=\"n\">refs_to_try</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n</span><span class=\"line\" data-line=\"148\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"149\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"150\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/tags/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"151\">        <span class=\"sa\">f</span><span class=\"s1\">&#39;refs/heads/</span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">,</span>\n</span><span class=\"line\" data-line=\"152\">    <span class=\"p\">]</span>\n</span><span class=\"line\" data-line=\"153\">    <span class=\"k\">for</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">refs_to_try</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"154\">        <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"155\">            <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_ref</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"156\">\n</span><span class=\"line\" data-line=\"157\">    <span class=\"c1\"># Name is SHA1</span>\n</span><span class=\"line\" data-line=\"158\">    <span class=\"n\">is_hex</span> <span class=\"o\">=</span> <span class=\"nb\">all</span> <span class=\"p\">(</span><span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">hexdigits</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"159\">    <span class=\"k\">if</span> <span class=\"nb\">len</span> <span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">40</span> <span class=\"ow\">and</span> <span class=\"n\">is_hex</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"160\">        <span class=\"k\">return</span> <span class=\"n\">name</span>\n</span><span class=\"line\" data-line=\"161\">\n</span><span class=\"line\" data-line=\"162\">    <span class=\"k\">assert</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;Unknown name </span><span class=\"si\">{</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"163\">\n</span><span class=\"line\" data-line=\"164\">\n</span><span class=\"line\" data-line=\"165\"><span class=\"k\">def</span> <span class=\"nf\">is_ignored</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"166\">    <span class=\"k\">return</span> <span class=\"s1\">&#39;.ugit&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">split</span> <span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">)</span>\n</span></code></pre></div>\n", "177117f2367f2d90a802260572662cf3661b5c08": "<div class=\"highlight\"><pre><span></span><code><span class=\"line\" data-line=\"1\"><span class=\"kn\">import</span> <span class=\"nn\">argparse</span>\n</span><span class=\"line\" data-line=\"2\"><span class=\"kn\">import</span> <span class=\"nn\">subprocess</span>\n</span><span class=\"line\" data-line=\"3\"><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n</span><span class=\"line\" data-line=\"4\"><span class=\"kn\">import</span> <span class=\"nn\">textwrap</span>\n</span><span class=\"line\" data-line=\"5\">\n</span><span class=\"line\" data-line=\"6\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">base</span>\n</span><span class=\"line\" data-line=\"7\"><span class=\"kn\">from</span> <span class=\"nn\">.</span> <span class=\"kn\">import</span> <span class=\"n\">data</span>\n</span><span class=\"line\" data-line=\"8\">\n</span><span class=\"line\" data-line=\"9\">\n</span><span class=\"line\" data-line=\"10\"><span class=\"k\">def</span> <span class=\"nf\">main</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"11\">    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"12\">    <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">func</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"13\">\n</span><span class=\"line\" data-line=\"14\">\n</span><span class=\"line\" data-line=\"15\"><span class=\"k\">def</span> <span class=\"nf\">parse_args</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"16\">    <span class=\"n\">parser</span> <span class=\"o\">=</span> <span class=\"n\">argparse</span><span class=\"o\">.</span><span class=\"n\">ArgumentParser</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"17\">\n</span><span class=\"line\" data-line=\"18\">    <span class=\"n\">commands</span> <span class=\"o\">=</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">add_subparsers</span> <span class=\"p\">(</span><span class=\"n\">dest</span><span class=\"o\">=</span><span class=\"s1\">&#39;command&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"19\">    <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n</span><span class=\"line\" data-line=\"20\">\n</span><span class=\"line\" data-line=\"21\">    <span class=\"n\">oid</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_oid</span>\n</span><span class=\"line\" data-line=\"22\">\n</span><span class=\"line\" data-line=\"23\">    <span class=\"n\">init_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;init&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"24\">    <span class=\"n\">init_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">init</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"25\">\n</span><span class=\"line\" data-line=\"26\">    <span class=\"n\">hash_object_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;hash-object&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"27\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">hash_object</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"28\">    <span class=\"n\">hash_object_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"29\">\n</span><span class=\"line\" data-line=\"30\">    <span class=\"n\">cat_file_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;cat-file&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"31\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">cat_file</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"32\">    <span class=\"n\">cat_file_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;object&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"33\">\n</span><span class=\"line\" data-line=\"34\">    <span class=\"n\">write_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;write-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"35\">    <span class=\"n\">write_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">write_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"36\">\n</span><span class=\"line\" data-line=\"37\">    <span class=\"n\">read_tree_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;read-tree&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"38\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">read_tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"39\">    <span class=\"n\">read_tree_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tree&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"40\">\n</span><span class=\"line\" data-line=\"41\">    <span class=\"n\">commit_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;commit&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"42\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">commit</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"43\">    <span class=\"n\">commit_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;-m&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;--message&#39;</span><span class=\"p\">,</span> <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"44\">\n</span><span class=\"line\" data-line=\"45\">    <span class=\"n\">log_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;log&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"46\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">log</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"47\">    <span class=\"n\">log_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"48\">\n</span><span class=\"line\" data-line=\"49\">    <span class=\"n\">checkout_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;checkout&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"50\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">checkout</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"51\">    <span class=\"n\">checkout_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"52\">\n</span><span class=\"line\" data-line=\"53\">    <span class=\"n\">tag_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;tag&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"54\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"55\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"56\">    <span class=\"n\">tag_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;oid&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"57\">\n</span><span class=\"line\" data-line=\"58\">    <span class=\"n\">branch_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;branch&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"59\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">branch</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"60\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"61\">    <span class=\"n\">branch_parser</span><span class=\"o\">.</span><span class=\"n\">add_argument</span> <span class=\"p\">(</span><span class=\"s1\">&#39;start_point&#39;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s1\">&#39;@&#39;</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"n\">oid</span><span class=\"p\">,</span> <span class=\"n\">nargs</span><span class=\"o\">=</span><span class=\"s1\">&#39;?&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"62\">\n</span><span class=\"line\" data-line=\"63\">    <span class=\"n\">k_parser</span> <span class=\"o\">=</span> <span class=\"n\">commands</span><span class=\"o\">.</span><span class=\"n\">add_parser</span> <span class=\"p\">(</span><span class=\"s1\">&#39;k&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"64\">    <span class=\"n\">k_parser</span><span class=\"o\">.</span><span class=\"n\">set_defaults</span> <span class=\"p\">(</span><span class=\"n\">func</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"65\">\n</span><span class=\"line\" data-line=\"66\">    <span class=\"k\">return</span> <span class=\"n\">parser</span><span class=\"o\">.</span><span class=\"n\">parse_args</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"67\">\n</span><span class=\"line\" data-line=\"68\">\n</span><span class=\"line\" data-line=\"69\"><span class=\"k\">def</span> <span class=\"nf\">init</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"70\">    <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">init</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"71\">\n</span><span class=\"line\" data-line=\"72\">\n</span><span class=\"line\" data-line=\"73\"><span class=\"k\">def</span> <span class=\"nf\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"74\">    <span class=\"k\">with</span> <span class=\"nb\">open</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"75\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">hash_object</span> <span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">read</span> <span class=\"p\">()))</span>\n</span><span class=\"line\" data-line=\"76\">\n</span><span class=\"line\" data-line=\"77\">\n</span><span class=\"line\" data-line=\"78\"><span class=\"k\">def</span> <span class=\"nf\">cat_file</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"79\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">flush</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"80\">    <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">buffer</span><span class=\"o\">.</span><span class=\"n\">write</span> <span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">get_object</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">object</span><span class=\"p\">,</span> <span class=\"n\">expected</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"81\">\n</span><span class=\"line\" data-line=\"82\">\n</span><span class=\"line\" data-line=\"83\"><span class=\"k\">def</span> <span class=\"nf\">write_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"84\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">write_tree</span> <span class=\"p\">())</span>\n</span><span class=\"line\" data-line=\"85\">\n</span><span class=\"line\" data-line=\"86\">\n</span><span class=\"line\" data-line=\"87\"><span class=\"k\">def</span> <span class=\"nf\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"88\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">read_tree</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">tree</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"89\">\n</span><span class=\"line\" data-line=\"90\">\n</span><span class=\"line\" data-line=\"91\"><span class=\"k\">def</span> <span class=\"nf\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"92\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">commit</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"93\">\n</span><span class=\"line\" data-line=\"94\">\n</span><span class=\"line\" data-line=\"95\"><span class=\"k\">def</span> <span class=\"nf\">log</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"96\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">({</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">}):</span>\n</span><span class=\"line\" data-line=\"97\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"98\">\n</span><span class=\"line\" data-line=\"99\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;commit </span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"100\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">textwrap</span><span class=\"o\">.</span><span class=\"n\">indent</span> <span class=\"p\">(</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s1\">&#39;    &#39;</span><span class=\"p\">))</span>\n</span><span class=\"line\" data-line=\"101\">        <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"102\">\n</span><span class=\"line\" data-line=\"103\">\n</span><span class=\"line\" data-line=\"104\"><span class=\"k\">def</span> <span class=\"nf\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"105\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">checkout</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"106\">\n</span><span class=\"line\" data-line=\"107\">\n</span><span class=\"line\" data-line=\"108\"><span class=\"k\">def</span> <span class=\"nf\">tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"109\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_tag</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"110\">\n</span><span class=\"line\" data-line=\"111\">\n</span><span class=\"line\" data-line=\"112\"><span class=\"k\">def</span> <span class=\"nf\">branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"113\">    <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">create_branch</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"114\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s1\">&#39;Branch </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s1\"> created at </span><span class=\"si\">{</span><span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">start_point</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&#39;</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"115\">\n</span><span class=\"line\" data-line=\"116\">\n</span><span class=\"line\" data-line=\"117\"><span class=\"k\">def</span> <span class=\"nf\">k</span> <span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"118\">    <span class=\"n\">dot</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;digraph commits {</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"119\">\n</span><span class=\"line\" data-line=\"120\">    <span class=\"n\">oids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span> <span class=\"p\">()</span>\n</span><span class=\"line\" data-line=\"121\">    <span class=\"k\">for</span> <span class=\"n\">refname</span><span class=\"p\">,</span> <span class=\"n\">ref</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">iter_refs</span> <span class=\"p\">():</span>\n</span><span class=\"line\" data-line=\"122\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=note]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"123\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">refname</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">ref</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"124\">        <span class=\"n\">oids</span><span class=\"o\">.</span><span class=\"n\">add</span> <span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"125\">\n</span><span class=\"line\" data-line=\"126\">    <span class=\"k\">for</span> <span class=\"n\">oid</span> <span class=\"ow\">in</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">iter_commits_and_parents</span> <span class=\"p\">(</span><span class=\"n\">oids</span><span class=\"p\">):</span>\n</span><span class=\"line\" data-line=\"127\">        <span class=\"n\">commit</span> <span class=\"o\">=</span> <span class=\"n\">base</span><span class=\"o\">.</span><span class=\"n\">get_commit</span> <span class=\"p\">(</span><span class=\"n\">oid</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"128\">        <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; [shape=box style=filled label=&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"s1\">&quot;]</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"129\">        <span class=\"k\">if</span> <span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"130\">            <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;&quot;</span><span class=\"si\">{</span><span class=\"n\">oid</span><span class=\"si\">}</span><span class=\"s1\">&quot; -&gt; &quot;</span><span class=\"si\">{</span><span class=\"n\">commit</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"si\">}</span><span class=\"s1\">&quot;</span><span class=\"se\">\\n</span><span class=\"s1\">&#39;</span>\n</span><span class=\"line\" data-line=\"131\">\n</span><span class=\"line\" data-line=\"132\">    <span class=\"n\">dot</span> <span class=\"o\">+=</span> <span class=\"s1\">&#39;}&#39;</span>\n</span><span class=\"line\" data-line=\"133\">    <span class=\"nb\">print</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"p\">)</span>\n</span><span class=\"line\" data-line=\"134\">\n</span><span class=\"line\" data-line=\"135\">    <span class=\"k\">with</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span> <span class=\"p\">(</span>\n</span><span class=\"line\" data-line=\"136\">            <span class=\"p\">[</span><span class=\"s1\">&#39;dot&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;-Tgtk&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;/dev/stdin&#39;</span><span class=\"p\">],</span>\n</span><span class=\"line\" data-line=\"137\">            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">proc</span><span class=\"p\">:</span>\n</span><span class=\"line\" data-line=\"138\">        <span class=\"n\">proc</span><span class=\"o\">.</span><span class=\"n\">communicate</span> <span class=\"p\">(</span><span class=\"n\">dot</span><span class=\"o\">.</span><span class=\"n\">encode</span> <span class=\"p\">())</span>\n</span></code></pre></div>\n"}}